[//]: # (src/app/resources/telegram/logic.md)


# ü§ñ Telegram ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Ä–µ—Å—É—Ä—Å–∞ AssistChat

---

## üß© 1. –û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

**–†–æ–ª—å:**
Telegram-–ø—Ä–æ–≤–∞–π–¥–µ—Ä ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∞–≥–µ–Ω—Ç, –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–π –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É Telegram-–∞–∫–∫–∞—É–Ω—Ç—É.
–ö–∞–∂–¥—ã–π —Ä–µ—Å—É—Ä—Å (`resource_id`) = –æ—Ç–¥–µ–ª—å–Ω–∞—è Telegram-—Å–µ—Å—Å–∏—è (`string_session`).
–ö–∞–∂–¥—ã–π —Ä–µ—Å—É—Ä—Å –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–æ **5 —Ä–æ–ª–µ–π** (teacher, assistant, analyst –∏ —Ç.–ø.), –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤–æ –≤—Ä–µ–º—è –¥–∏–∞–ª–æ–≥–∞.

–†–∞–±–æ—Ç–∞ –≤–æ–∑–º–æ–∂–Ω–∞, –µ—Å–ª–∏:

* `resource.status == 'active'`
* `bot_enabled == True`

---

## ‚öôÔ∏è 2. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª Telegram-—Ä–µ—Å—É—Ä—Å–∞

1. **–ê–∫—Ç–∏–≤–∞—Ü–∏—è**

   * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `App ID`, `App Hash`, `Phone`.
   * `/api/resource/{id}/activate` —Å–æ–∑–¥–∞—ë—Ç Telethon-–∫–ª–∏–µ–Ω—Ç, –ø–æ–ª—É—á–∞–µ—Ç `string_session`.
   * –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏:

     * `status ‚Üí active`
     * `meta_json.creds.string_session` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.

2. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ—Ä–∫–µ—Ä–∞**

   * `BotManager` —Å–∫–∞–Ω–∏—Ä—É–µ—Ç `src/app/resources/*`.
   * –î–ª—è –≤—Å–µ—Ö `resources` —Å `provider='telegram'` –∏ `status='active'` –∑–∞–ø—É—Å–∫–∞–µ—Ç `TelegramWorker`.
   * –û–¥–∏–Ω `TelegramWorker` –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç –æ–¥–∏–Ω `resource_id`.

3. **–ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞**

   * `TelegramWorker` —Å–æ–∑–¥–∞—ë—Ç Telethon-–∫–ª–∏–µ–Ω—Ç.
   * –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è `NewMessage`.
   * –ö–∞–∂–¥–æ–µ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ `TelegramDialogEngine`.

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π**

   * `TelegramDialogEngine`:

     * —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å–ø–∞–º, self-reply, –¥—É–±–ª–∏;
     * –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∏–∑ `messages` –ø–æ `(resource_id, peer_id)`;
     * –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å;
     * —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø—Ä–æ–º–ø—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–æ–ª–∏;
     * –≤—ã–∑—ã–≤–∞–µ—Ç `OpenAIClient.handle_message()`.

5. **–û—Ç–≤–µ—Ç –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

   * `OpenAIClient` –≤—ã–∑—ã–≤–∞–µ—Ç –º–æ–¥–µ–ª—å GPT-5 (–∏–ª–∏ 4o-mini), –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç, TTS/Voice –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏;
   * –æ—Ç–≤–µ—Ç –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ `messages`;
   * `TelegramWorker` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é;
   * –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è `usage_today`, `cost_today`, `last_activity`.

---

## üé≠ 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ `meta_json`

```json
{
  "creds": {
    "app_id": 123456,
    "app_hash": "xxxx",
    "string_session": "1ABCD..."
  },
  "session": {
    "active": true,
    "whitelist": ["andrew"],
    "blacklist": ["spam_bot"],
    "history_limit": 30
  },
  "roles": [
    {
      "name": "–£—á–∏—Ç–µ–ª—å –∞–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω—Å–∫–æ–≥–æ",
      "description": "–û–±—É—á–∞–µ—Ç —è–∑—ã–∫—É —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ —Ç–µ—Å—Ç–∞–º–∏",
      "system_prompt": "–¢—ã ‚Äî –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∞–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω—Å–∫–æ–≥–æ...",
      "modes": {
        "lesson": "–ü–æ—à–∞–≥–æ–≤—ã–µ —É—Ä–æ–∫–∏",
        "dialogue": "–ü—Ä–∞–∫—Ç–∏–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤",
        "quiz": "–ö–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ—Å—Ç—ã",
        "translate": "–ü–µ—Ä–µ–≤–æ–¥—ã –∏ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞"
      },
      "temperature": 0.7,
      "top_p": 1.0,
      "max_tokens": 1024,
      "voice_enabled": true
    }
  ]
}
```

---

## üß† 4. –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏

* –í –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é —Ä–æ–ª—å:

  * —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `/role N`
  * –∏–ª–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Telegram-–±–æ—Ç–∞ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏)
* `TelegramDialogEngine` –±–µ—Ä—ë—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏ –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–æ–ª–∏.
* –ö–∞–∂–¥–∞—è —Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è.

---

## üí¨ 5. –ò—Å—Ç–æ—Ä–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç

* –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `messages`:

  | –ü–æ–ª–µ          | –û–ø–∏—Å–∞–Ω–∏–µ                 |
  | ------------- | ------------------------ |
  | `id`          | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
  | `resource_id` | –°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ—Å—É—Ä—Å         |
  | `peer_id`     | Telegram ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞  |
  | `role`        | –¢–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è —Ä–æ–ª—å    |
  | `direction`   | `'in'` / `'out'`         |
  | `text`        | –°–æ–¥–µ—Ä–∂–∏–º–æ–µ               |
  | `tokens_used` | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã    |
  | `created_at`  | –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏           |

* –î–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `session.history_limit` –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.

* –°—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è –≤ –ë–î, –Ω–æ –Ω–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ prompt-–∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.

---

## üñ•Ô∏è 6. –†–∞–±–æ—Ç–∞ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

* –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/resources/telegram/{id}` –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ñ–æ—Ä–º—É –∏–∑ `settings.yaml`.

* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç:

  * –¥–æ–±–∞–≤–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å –¥–æ 5 —Ä–æ–ª–µ–π;
  * –∏–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç –∏—Å—Ç–æ—Ä–∏–∏;
  * —É–ø—Ä–∞–≤–ª—è—Ç—å –±–µ–ª—ã–º/—á—ë—Ä–Ω—ã–º —Å–ø–∏—Å–∫–æ–º;
  * –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é.

* –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ `router.py`:

  * `/activate` ‚Äî –∞–∫—Ç–∏–≤–∞—Ü–∏—è Telethon;
  * `/toggle` ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å;
  * `/status` ‚Äî —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

---

## üí∞ 7. –£—á—ë—Ç —Ç–æ–∫–µ–Ω–æ–≤ –∏ –ª–∏–º–∏—Ç–æ–≤

* –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç OpenAI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `usage.total_tokens`.
* `TelegramDialogEngine` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç usage ‚Üí `messages.tokens_used`.
* `BotManager` —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ —Å—É–º–º–∏—Ä—É–µ—Ç —Ä–∞—Å—Ö–æ–¥ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ `user_id` –∏ `resource_id`.
* –ï—Å–ª–∏ –ª–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω –∏ `autostop=true` ‚Üí `status='pause'`.

---

## üß© 8. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

* –û–¥–∏–Ω `TelegramWorker` = –æ–¥–∏–Ω `resource_id` = –æ–¥–∏–Ω Telethon-–∫–ª–∏–µ–Ω—Ç.
* `BotManager` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞ –Ω–∞ —Ä–µ—Å—É—Ä—Å.
* –ù–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ (—Ä–∞–∑–Ω—ã–µ `users`) —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
* –ù–µ—Å–∫–æ–ª—å–∫–æ —Ä–æ–ª–µ–π –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Ç—Å—è –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤.

---

## ‚úÖ 9. –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

* –ù–µ—Ç –¥—É–±–ª–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –≤–æ—Ä–∫–µ—Ä).
* –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å ‚Äî Telethon –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è.
* –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—É—Ä OpenAI –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π.
* –ü—Ä–æ—Å—Ç–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –ø–æ —á–∏—Å–ª—É —Å–µ—Å—Å–∏–π –∏ —Ä–æ–ª–µ–π.
* –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞ –∏ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤.

---