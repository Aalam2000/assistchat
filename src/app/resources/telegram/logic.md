[//]: # (src/app/resources/telegram/logic.md)
# ü§ñ Telegram ‚Äî –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Ä–µ—Å—É—Ä—Å–∞ AssistChat

---

## üß© 1. –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Ä–µ—Å—É—Ä—Å–∞

**–†–æ–ª—å:**  
Telegram-–ø—Ä–æ–≤–∞–π–¥–µ—Ä ‚Äî –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –∞–≥–µ–Ω—Ç, –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–π –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É Telegram-–∞–∫–∫–∞—É–Ω—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–µ—Ä–µ–∑ `string_session`).  
–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
- `user.bot_enabled = True`
- `resource.status = 'active'`

### –≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç—ã:
1. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç `App ID`, `App Hash`, `String Session` (–∏–ª–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–µ—Ñ–ª–∞–π—Ç).
   - –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è Telethon-–∫–ª–∏–µ–Ω—Ç–∞, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–∞—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

2. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª –∏ –ø—Ä–æ–º–ø—Ç–æ–≤**
   - –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ–ª—è:
     - `prompts.settings`, `prompts.rules_common`, `prompts.rules_dialog`
     - `lists.whitelist`, `lists.blacklist`
     - `extra.allow_groups`
   - –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ —É–ø—Ä–∞–≤–ª—è—é—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.

3. **–†–∞–±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø–∞—Ö**
   - –ï—Å–ª–∏ `extra.allow_groups=True`, worker —Å–ª—É—à–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø–∞—Ö, –≥–¥–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∞–∫–∫–∞—É–Ω—Ç.
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è:
     - –µ—Å–ª–∏ –≤ `blacklist` ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è;
     - –µ—Å–ª–∏ –≤ `whitelist` ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ.

4. **–î–∏–∞–ª–æ–≥–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏**
   - –ü—Ä–∏ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ OpenAI API.
   - –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ —Å –∫–∞–∂–¥—ã–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `messages`.
   - –î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—â–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è, –∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ **X —Å–æ–æ–±—â–µ–Ω–∏–π**, –≥–¥–µ X –∑–∞–¥–∞—ë—Ç—Å—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–µ—Å—É—Ä—Å–∞ (`limits.history_length`).
     - –°—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è, –Ω–æ –Ω–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–∏–∞–ª–æ–≥–∞; –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –∞—Ä—Ö–∏–≤–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.

5. **–°–∏—Å—Ç–µ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞**
   - –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `messages`.
   - –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞—Å—Ö–æ–¥–∞ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –ª–∏–º–∏—Ç–æ–≤ (—Å–º. –Ω–∏–∂–µ).
   - –ï—Å–ª–∏ `bot_enabled=False` –∏–ª–∏ `status='pause'` ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è.

---

## ‚öôÔ∏è 2. –¢–∞–±–ª–∏—Ü–∞ `resources` ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**  
–¢–∞–±–ª–∏—Ü–∞ `resources` —Ö—Ä–∞–Ω–∏—Ç –≤—Å–µ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Telegram, Zoom, Voice –∏ —Ç.–ø.).  
–ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–µ—Å—É—Ä—Å (—É—á—ë—Ç–∫–∞, –∫–∞–Ω–∞–ª, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è), –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

| –ü–æ–ª–µ | –¢–∏–ø | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----|-------------|
| `id` | int | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ä–µ—Å—É—Ä—Å–∞ |
| `user_id` | int | –í–ª–∞–¥–µ–ª–µ—Ü (–≤–Ω–µ—à–Ω–∏–π –∫–ª—é—á –Ω–∞ `users.id`) |
| `provider` | str | –¢–∏–ø —Ä–µ—Å—É—Ä—Å–∞ (`telegram`, `zoom`, `voice` –∏ —Ç.–¥.) |
| `name` | str | –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ |
| `status` | enum | `active` / `pause` / `error` / `ready` |
| `meta_json` | JSON | –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –∫–∞–∫ –≤ `providers.py` |
| `created_at` | datetime | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è |
| `updated_at` | datetime | –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ |
| `last_activity` | datetime | –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç/–æ—Ç–≤–µ—Ç –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ |
| `usage_today` | int | –°—É–º–º–∞ —Ç–æ–∫–µ–Ω–æ–≤ –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å |
| `cost_today` | float | –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å |
| `error_message` | str | –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—à–∏–±–∫–∏ (–µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å `error`) |

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ `meta_json` –¥–ª—è Telegram:**

```json
{
  "creds": {
    "app_id": 123456,
    "app_hash": "xxxx",
    "string_session": "1ABCD...",
    "code": ""
  },
  "extra": {
    "phone_e164": "+99450XXXXXXX",
    "allow_groups": true,
    "billing_mode": "per_token",
    "provider": "telethon"
  },
  "lists": {
    "whitelist": ["mehman", "ahmad"],
    "blacklist": ["bot123"]
  },
  "prompts": {
    "settings": "...",
    "rules_common": "...",
    "rules_dialog": "..."
  },
  "limits": {
    "tokens_limit": 50000,
    "autostop": true
  }
}
```

## üñ•Ô∏è 3. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /resources

–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ‚Äú–†–µ—Å—É—Ä—Å—ã‚Äù –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—É—Ä—Å–µ:

–ö–æ–ª–æ–Ω–∫–∞	–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö	–ü—Ä–∏–º–µ—Ä
–ü—Ä–æ–≤–∞–π–¥–µ—Ä	resource.provider	Telegram
–ù–∞–∑–≤–∞–Ω–∏–µ	resource.name	Telegram #1
–°—Ç–∞—Ç—É—Å	resource.status	üü¢ active / ‚è∏ pause / üî¥ error
–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å	last_activity	2025-10-11 20:45
–°–µ–≥–æ–¥–Ω—è (—Ç–æ–∫–µ–Ω—ã)	usage_today	324
–°—Ç–æ–∏–º–æ—Å—Ç—å (AZN)	cost_today	0.08
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ	–∫–Ω–æ–ø–∫–∏ ‚Äú–û—Ç–∫—Ä—ã—Ç—å‚Äù, ‚Äú–ü–∞—É–∑–∞‚Äù, ‚Äú–£–¥–∞–ª–∏—Ç—å‚Äù	‚Äî
–ö–Ω–æ–ø–∫–∞ ‚Äú–û—Ç–∫—Ä—ã—Ç—å‚Äù

–í–µ–¥—ë—Ç –Ω–∞ /resources/telegram/{resource.id}

–ó–∞–≥—Ä—É–∂–∞–µ—Ç HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—É resources/telegram.html, –≥–¥–µ —Å—Ç—Ä–æ–∏—Ç—Å—è —Ñ–æ—Ä–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ö–µ–º—ã –∏–∑ providers.py

–í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –∏–∑ resource.meta_json

–ö–Ω–æ–ø–∫–∞ ‚Äú–ü–∞—É–∑–∞/–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å‚Äù

–ú–µ–Ω—è–µ—Ç status —Ä–µ—Å—É—Ä—Å–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ (AJAX —á–µ—Ä–µ–∑ /api/resource/status)

–ö–Ω–æ–ø–∫–∞ ‚Äú–£–¥–∞–ª–∏—Ç—å‚Äù

–ü–æ–º–µ—á–∞–µ—Ç status='deleted' –∏ —É–±–∏—Ä–∞–µ—Ç –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –ë–î)

## üíæ 4. –ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏

*–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ‚Äú–°–æ—Ö—Ä–∞–Ω–∏—Ç—å‚Äù –≤ —Ñ–æ—Ä–º–µ Telegram:*

- —Ñ—Ä–æ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON –Ω–∞ /api/resource/update/{id}

- –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π validate_provider_meta("telegram", meta_json)

- –ø—Ä–∏ —É—Å–ø–µ—Ö–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è meta_json, updated_at –∏ status='ready'.

- –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ Telethon:

- status –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ active

- last_activity –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

- string_session —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ meta_json.creds.string_session

*–ü—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–ª–∏ –æ—à–∏–±–∫–µ:*

- status ‚Üí error

- error_message —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ

- worker –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –µ—Å–ª–∏ bot_enabled=True.

## üí∞ 5. –ö–æ–Ω—Ç—Ä–æ–ª—å —Ç–æ–∫–µ–Ω–æ–≤ –∏ –±–∏–ª–ª–∏–Ω–≥

*–ü—Ä–æ—Ü–µ—Å—Å:*

- –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç Telegram-–∞–≥–µ–Ω—Ç–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ OpenAI API, —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è usage.total_tokens.

- –í —Ç–∞–±–ª–∏—Ü–µ messages:

- tokens_used

- cost_azn

- model

- timestamp

*–í usage_summary (–ø–æ user_id, provider, date):*

- tokens_total

- cost_total

- limit_exceeded

*–ú–µ–Ω–µ–¥–∂–µ—Ä (bot/manager.py) —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏:*

- —Å—É–º–º–∏—Ä—É–µ—Ç —Ä–∞—Å—Ö–æ–¥ —Ç–æ–∫–µ–Ω–æ–≤;

- –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ ‚Äî —Å—Ç–∞–≤–∏—Ç status='pause' –∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è;

- –µ—Å–ª–∏ autostop=True ‚Äî worker –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ.

*–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –º–æ–¥–µ–ª—å:*

- 1 —Ç–æ–∫–µ–Ω = X AZN (—É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ config.py)

- per_token: —Å—Ç–æ–∏–º–æ—Å—Ç—å = —Ç–æ–∫–µ–Ω—ã √ó —Å—Ç–∞–≤–∫–∞

- per_message: —Ñ–∏–∫—Å –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ

- flat_rate: —Ñ–∏–∫—Å –≤ –¥–µ–Ω—å, —Ç–æ–∫–µ–Ω—ã ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏